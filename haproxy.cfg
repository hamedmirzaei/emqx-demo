global
    log stdout format raw local0
    maxconn 250000 # Consider increasing this based on your expected concurrent connections

defaults
    mode tcp # Essential for MQTT (raw TCP stream)
    timeout client 50000ms # Timeout for client inactivity
    timeout server 50000ms # Timeout for server inactivity
    timeout connect 5000ms # Timeout for connecting to a backend server
    retries 3 # Number of retries to connect to a server
    option tcplog # Log TCP connections

listen mqtt_broker
    bind *:1883 # HAProxy listens on port 1883 inside its container (mapped to host 1884)
    mode tcp
    balance roundrobin # Use roundrobin for even distribution, or 'leastconn' for fewer active connections per node

    # EMQX cluster nodes
    # Use the 'hostname' or 'alias' from your Docker Compose for HAProxy to resolve
    # The port '1883' is the internal MQTT port of the EMQX containers
    server emqx1 node1.local:1883 check inter 1000ms rise 2 fall 3
    server emqx2 node2.local:1883 check inter 1000ms rise 2 fall 3

    # Explanation of 'check inter 1000ms rise 2 fall 3':
    # - check: Enables health checks for the backend servers.
    # - inter 1000ms: Check every 1000 milliseconds (1 second).
    # - rise 2: A server is considered "up" after 2 successful consecutive health checks.
    # - fall 3: A server is considered "down" after 3 consecutive failed health checks.
